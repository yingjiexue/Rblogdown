<script type="text/javascript"
src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>R与Mongo数据库交互演示 - Yingjie</title>
    <meta property="og:title" content="R与Mongo数据库交互演示 - Yingjie">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
      <meta property="description" content="MongoDB 是一个基于分布式文件存储的数据库。由 C&#43;&#43; 语言编写。旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。同时，他也是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。而R语言作为一种统计数据分析语言，必然需要输入数据才能进行各种运算，那么当R语言偶遇MongoDB时，该怎么从MongoDB中读入数据，又该如何将数据写入MongoDB &amp;hellip;">
      <meta property="og:description" content="MongoDB 是一个基于分布式文件存储的数据库。由 C&#43;&#43; 语言编写。旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。同时，他也是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。而R语言作为一种统计数据分析语言，必然需要输入数据才能进行各种运算，那么当R语言偶遇MongoDB时，该怎么从MongoDB中读入数据，又该如何将数据写入MongoDB &amp;hellip;">
      
    

    
    

    

    
    


<link href='//yingjie.org/highlight.js/9.11.0/styles/github.min.css' rel='stylesheet' type='text/css' />



    <link rel="stylesheet" href="../../../../css/style.css" />
    <link rel="stylesheet" href="../../../../css/fonts.css" />
    
  </head>

  
  <body class="2021">
    <header class="masthead">
      <h1><a href="../../../../">Yingjie</a></h1>



      <nav class="menu">
  <input id="menu-check" type="checkbox" />
  <label id="menu-label" for="menu-check" class="unselectable">
    <span class="icon close-icon">✕</span>
    <span class="icon open-icon">☰</span>
    <span class="text">Menu</span>
  </label>
  <ul>
  
  
  <li><a href="../../../../">主页</a></li>
  
  <li><a href="../../../../cn/">日志</a></li>
  
  <li><a href="../../../../research/">研究</a></li>
  
  <li><a href="../../../../cn_about/">关于</a></li>
  
  <li><a href="../../../../en/">Blog</a></li>
  
  <li><a href="../../../../en_about/">About</a></li>
  
  
  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
<h1>R与Mongo数据库交互演示</h1>

<h3>薛英杰
  /  2021-04-24</h3>
<hr>


      </header>




<script src="../../../../rmarkdown-libs/header-attrs/header-attrs.js"></script>
<script src="../../../../rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="../../../../rmarkdown-libs/jquery/jquery.min.js"></script>
<link href="../../../../rmarkdown-libs/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="../../../../rmarkdown-libs/datatables-binding/datatables.js"></script>
<link href="../../../../rmarkdown-libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="../../../../rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="../../../../rmarkdown-libs/dt-core/js/jquery.dataTables.min.js"></script>
<link href="../../../../rmarkdown-libs/dt-ext-buttons/css/buttons.dataTables.min.css" rel="stylesheet" />
<script src="../../../../rmarkdown-libs/dt-ext-buttons/js/dataTables.buttons.min.js"></script>
<script src="../../../../rmarkdown-libs/dt-ext-buttons/js/buttons.flash.min.js"></script>
<script src="../../../../rmarkdown-libs/dt-ext-buttons/js/buttons.html5.min.js"></script>
<script src="../../../../rmarkdown-libs/dt-ext-buttons/js/buttons.colVis.min.js"></script>
<script src="../../../../rmarkdown-libs/dt-ext-buttons/js/buttons.print.min.js"></script>
<link href="../../../../rmarkdown-libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="../../../../rmarkdown-libs/crosstalk/js/crosstalk.min.js"></script>


<p>MongoDB 是一个基于分布式文件存储的数据库。由 C++ 语言编写。旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。同时，他也是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。而R语言作为一种统计数据分析语言，必然需要输入数据才能进行各种运算，那么当R语言偶遇MongoDB时，该怎么从MongoDB中读入数据，又该如何将数据写入MongoDB呢？</p>
<p>我们都知道R是“包治百病”，与MongoDB交互自然也离不开package。链接MongoDB的R package有三个，分别为：rmongodb、RMongo、Mongolite，他们版本和使用手册如下：</p>
<p>Package:<a href="https://cran.r-project.org/src/contrib/Archive/rmongodb/">rmongodb(2011)</a>、<a href="https://cran.r-project.org/src/contrib/Archive/RMongo/">RMongo(2011)</a>、<a href="https://cran.r-project.org/web/packages/mongolite/index.html">Mongolite(2014)</a></p>
<p>User Manual:<a href="https://www.rdocumentation.org/packages/rmongodb/versions/1.8.0">rmongodb Usage</a> <a href="https://www.rdocumentation.org/packages/RMongo/versions/0.0.25/topics/RMongo-package">RMongo Usage</a> <a href="https://jeroen.github.io/mongolite/">Mongolite Usage</a></p>
<p>目前rmongodb和RMongo都已下架，上面的package和User Manual均为历史遗留版本，不过也都能使用。今天重点介绍一下Mongolite包，通过他来实现R语言与MongoDB的交互，可以参考Presentation: <a href="http://jeroen.github.io/mongo-slides">UseR 2015 slides</a>。</p>
<p>要实现R语言与MongoDB的交互，首先需要开启MongoDB，在命令行窗口中输入：</p>
<pre><code>    D:Mongo\bin\mongod --dbpath D:Mongo\data\db
    </code></pre>
<p><img src="../../../../cn/2021-04-24-r与mongo数据库交互演示_files/mongs.PNG" /></p>
<p>接下来在R环境中加载相关软件包，建立R与MongoDB链接，具体如下：</p>
<pre class="r"><code>##加载软件包
pacman::p_load(data.table,plyr,stringr,dplyr,mongolite,future.apply,future)

##建立R与MongoDB数据库的链接，collection为数据表对应的文件，db为数据库中的表
m&lt;-mongo(collection = &quot;tradedatadaily&quot;,db=&quot;stockdata&quot;)

##断开链接
rm()
gc()</code></pre>
<pre><code>##           used (Mb) gc trigger (Mb) max used (Mb)
## Ncells  713971 38.2    1365864   73  1365864   73
## Vcells 1209085  9.3    8388608   64  1691184   13</code></pre>
<div id="查询数据" class="section level3">
<h3>1.查询数据</h3>
<blockquote>
<p>假设我们需要从MongoDB数据库中查找2021-04-21股票交易数据，统计各收益水平下的上市公司数量，具体代码如下：</p>
</blockquote>
<pre class="r"><code>##加载软件包
pacman::p_load(data.table,plyr,stringr,dplyr,mongolite,future.apply,future)

##建立R与MongoDB数据库的链接，collection为数据表对应的文件，db为数据库中的表
m&lt;-mongo(collection = &quot;tradedatadaily&quot;,db=&quot;stockdata&quot;)

##查询字段有上市公司代码（symbol）、收盘价(close)、前收盘价(pre_close)，查询条件为交易日期(trade_date)等于2021-04-21

tradedata&lt;-m$find(query = &#39;{&quot;trade_date&quot;:&quot;20210421&quot;}&#39;,
                  fields = &#39;{&quot;symbol&quot;:&quot;ture&quot;,&quot;trade_date&quot;:&quot;ture&quot;,&quot;close&quot;:&quot;ture&quot;,&quot;pre_close&quot;:&quot;ture&quot;}&#39;)
head(tradedata)</code></pre>
<pre><code>##               _id symbol trade_date close pre_close
## 1 000001_20210421 000001   20210421 23.01     21.69
## 2 000002_20210421 000002   20210421 28.65     28.73
## 3 000004_20210421 000004   20210421 18.49     18.88
## 4 000005_20210421 000005   20210421  2.30      2.31
## 5 000006_20210421 000006   20210421  5.54      5.53
## 6 000007_20210421 000007   20210421  3.83      3.95</code></pre>
<pre class="r"><code>##计算收益并分组统计上市公司数量
fdstb&lt;-tradedata%&gt;%mutate(rets=close/pre_close-1)%&gt;%mutate(groups=cut(rets,c(-0.25,-0.15,-0.1,-0.05,-0.03,-.01,0,0.01,0.03,0.05,0.1,0.15,0.25),labels = c(&quot;&lt;-15%&quot;,&quot;&lt;-10%&quot;,&quot;&lt;-5%&quot;,&quot;&lt;-3%&quot;,&quot;&lt;-1%&quot;,&quot;&lt;0%&quot;,&quot;0%&lt;&quot;,&quot;1%&lt;&quot;,&quot;3%&lt;&quot;,&quot;5%&lt;&quot;,&quot;10%&lt;&quot;,&quot;15%&lt;&quot;),right=F))%&gt;%group_by(groups)%&gt;%summarise(cout=n())

barplot(fdstb$cout,names.arg = fdstb$groups,col =c(rep(&quot;green&quot;,6),rep(&quot;red&quot;,6)),cex.names = 0.7,ylim = c(0,1350),axes = F)
text(c(0.7,1.9,3.1,4.3,5.5,6.7,7.9,9.1,10.3,11.5,12.6,13.9),fdstb$cout+c(8,8,8,8,8,10,10,10,10.3,9,9,9)+32,fdstb$cout,cex = 0.8)</code></pre>
<p><img src="../../../../cn/2021-04-24-r与mongo数据库交互演示_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<blockquote>
<p>从MongoDB数据库中提取2021年IPO且市值的公司</p>
</blockquote>
<pre class="r"><code>##加载软件包
pacman::p_load(data.table,plyr,stringr,dplyr,mongolite,future.apply,future,flextable,DT)

##建立R与MongoDB数据库的链接，collection为数据表对应的文件，db为数据库中的表
m&lt;-mongo(collection = &quot;stockbase&quot;,db=&quot;stockdata&quot;)

##查询字段有上市公司代码（symbol）、股票名称(name)、上市日期(list_date)，查询条件为上市日期(list_date)大于2021-01-01

newfirm&lt;-m$find(query = &#39;{&quot;list_date&quot;:{&quot;$gt&quot;:&quot;20210101&quot;}}&#39;,
                  fields = &#39;{&quot;symbol&quot;:&quot;ture&quot;,&quot;name&quot;:&quot;ture&quot;,&quot;list_date&quot;:&quot;ture&quot;,&quot;_id&quot;:&quot;false&quot;}&#39;)
DT::datatable(newfirm,rownames = FALSE,extensions = &#39;Buttons&#39;, options = list(dom = &#39;Bfrtip&#39;,buttons = c( &#39;print&#39;)))</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","extensions":["Buttons"],"data":[["003030","003031","003032","003033","003035","003036","003037","003038","003039","003040","003041","003042","003043","300926","300927","300928","300929","300930","300931","300932","300933","300935","300936","300937","300938","300939","300940","300941","300942","300943","300945","300946","300947","300948","300949","300950","300951","300952","300953","300955","300956","300957","300958","300959","300960","300961","300962","300963","300965","300966","300967","300968","300969","300970","300971","300972","300973","300975","300976","300977","300980","300983","600916","601279","601963","603324","603759","605005","605016","605055","605060","605077","605081","605086","605098","605117","605122","605133","605208","605228","605268","605277","605286","605298","605303","605337","605368","605378","605389","605398","688059","688070","688079","688083","688092","688109","688183","688191","688195","688201","688260","688315","688316","688317","688328","688329","688350","688456","688468","688533","688606","688607","688609","688611","688616","688617","688619","688626","688628","688630","688633","688636","688639","688656","688659","688661","688662","688663","688665","688667","688669","688676","688677","688680","688682","688683","688687","688689","688696","688819"],["003030","003031","003032","003033","003035","003036","003037","003038","003039","003040","003041","003042","003043","300926","300927","300928","300929","300930","300931","300932","300933","300935","300936","300937","300938","300939","300940","300941","300942","300943","300945","300946","300947","300948","300949","300950","300951","300952","300953","300955","300956","300957","300958","300959","300960","300961","300962","300963","300965","300966","300967","300968","300969","300970","300971","300972","300973","300975","300976","300977","300980","300983","600916","601279","601963","603324","603759","605005","605016","605055","605060","605077","605081","605086","605098","605117","605122","605133","605208","605228","605268","605277","605286","605298","605303","605337","605368","605378","605389","605398","688059","688070","688079","688083","688092","688109","688183","688191","688195","688201","688260","688315","688316","688317","688328","688329","688350","688456","688468","688533","688606","688607","688609","688611","688616","688617","688619","688626","688628","688630","688633","688636","688639","688656","688659","688661","688662","688663","688665","688667","688669","688676","688677","688680","688682","688683","688687","688689","688696","688819"],["祖名股份","中瓷电子","传智教育","征和工业","南网能源","泰坦股份","三和管桩","鑫铂股份","顺控发展","楚天龙","真爱美家","中农联合","华亚智能","博俊科技","江天化学","华安鑫创","华骐环保","屹通新材","通用电梯","三友联众","中辰股份","盈建科","中英科技","药易购","信测标准","秋田微","南极光","创识科技","易瑞生物","春晖智控","曼卡龙","恒而达","德必集团","冠中生态","奥雅设计","德固特","博硕科技","恒辉安防","震裕科技","嘉亨家化","英力股份","贝泰妮","建工修复","线上线下","通业科技","深水海纳","中金辐照","中洲特材","恒宇信通","共同药业","晓鸣股份","格林精密","恒帅股份","华绿生物","博亚精工","C万辰","立高食品","C商络","C达瑞","C瑞捷","C祥源","C尤安","中国黄金","英利汽车","重庆银行","盛剑环境","海天股份","合兴股份","百龙创园","迎丰股份","联德股份","华康股份","太和水","龙高股份","行动教育","德业股份","四方新材","嵘泰股份","永茂泰","神通科技","王力安防","新亚电子","同力日升","必得科技","园林股份","李子园","蓝天燃气","野马电池","长龄液压","新炬网络","华锐精密","纵横股份","美迪凯","中望软件","爱科科技","品茗股份","生益电子","智洋创新","腾景科技","信安世纪","昀冢科技","诺禾致源","青云科技-U","之江生物","深科达","艾隆科技","富淼科技","有研粉材","科美诊断","上声电子","奥泰生物","康众医疗","九联科技","杭州柯林","西力科技","惠泰医疗","罗普特","翔宇医疗","优利德","芯碁微装","星球石墨","智明达","N华恒","浩欧博","元琛科技","和林微纳","富信科技","新风光","四方光电","菱电电控","聚石化学","金盘科技","海泰新光","海优新材","霍莱沃","莱尔科技","凯因科技","银河微电","极米科技","天能股份"],["20210106","20210104","20210112","20210111","20210119","20210128","20210204","20210210","20210308","20210322","20210406","20210406","20210406","20210107","20210107","20210106","20210120","20210121","20210121","20210122","20210122","20210120","20210126","20210127","20210127","20210128","20210203","20210209","20210209","20210210","20210210","20210208","20210210","20210225","20210226","20210303","20210226","20210311","20210318","20210324","20210326","20210325","20210329","20210322","20210329","20210330","20210409","20210409","20210402","20210409","20210413","20210415","20210412","20210412","20210415","20210419","20210415","20210421","20210419","20210420","20210421","20210420","20210205","20210415","20210205","20210407","20210326","20210119","20210421","20210129","20210301","20210209","20210209","20210416","20210421","20210420","20210310","20210224","20210308","20210120","20210224","20210106","20210322","20210301","20210301","20210208","20210129","20210412","20210322","20210121","20210208","20210210","20210302","20210311","20210319","20210330","20210225","20210408","20210326","20210421","20210406","20210413","20210316","20210118","20210309","20210329","20210128","20210317","20210409","20210419","20210325","20210201","20210323","20210412","20210318","20210107","20210223","20210331","20210201","20210401","20210324","20210408","20210422","20210113","20210331","20210329","20210401","20210413","20210209","20210312","20210125","20210309","20210226","20210122","20210420","20210412","20210208","20210127","20210303","20210118"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>_id<\/th>\n      <th>symbol<\/th>\n      <th>name<\/th>\n      <th>list_date<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"Bfrtip","buttons":["print"],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>


  <footer>
  
  



<script src="//yingjie.org/highlight.js/9.11.0/highlight.min.js"></script>



<script src="//yingjie.org/highlight.js/9.11.0/languages/r.min.js"></script>
<script src="//yingjie.org/highlight.js/9.11.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">© <a href="../../../../">Yingjie Xue</a>2020| <a href="https://github.com/yingjiexue">Github</a></div>
  
  </footer>
  </article>
  
  </body>
</html>

